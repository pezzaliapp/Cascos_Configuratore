<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Documento</title>
<style>
  :root{ --ink:#eef2ff; --line:#243b7a; --bg:#0b1022; --card:#111735; --topH:56px }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
  .top{
    position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;justify-content:space-between;
    padding:12px clamp(12px, 2vw, 16px);
    padding-top:calc(12px + env(safe-area-inset-top));
    background:#0c1430cc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)
  }
  .left,.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{
    display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;text-decoration:none;
    color:var(--ink);background:#0e193f;border:1px solid var(--line);cursor:pointer;white-space:nowrap
  }
  .btn:hover{border-color:#2dd4bf}
  .name{font-size:12px;opacity:.8;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:48vw}
  .wrap{height:calc(100vh - var(--topH));}
  iframe, embed, object{border:0;width:100%;height:100%;background:#000}
  .fallback{display:none;place-items:center;height:100%;background:var(--card);border-top:1px solid var(--line)}
  .fallback.show{display:grid}
  .note{max-width:900px;margin:0 auto;padding:16px;text-align:center;color:#cbd5e1}
  @media (max-width:680px){
    :root{ --topH:64px }
    .name{max-width:38vw}
  }
</style>
</head>
<body>
  <div class="top">
    <div class="left">
      <a class="btn" id="back" href="./index.html">‚Üê Torna al configuratore</a>
      <a class="btn" href="./index.html">üè† Home</a>
      <span class="name" id="name"></span>
    </div>
    <div class="right">
      <button class="btn" id="openExt" type="button">üåê Apri fuori dall‚Äôapp</button>
      <button class="btn" id="copyLink" type="button">üîó Copia link</button>
    </div>
  </div>

  <div class="wrap" id="viewWrap">
    <iframe id="pdf" title="Documento PDF" referrerpolicy="no-referrer-when-downgrade"></iframe>
    <div class="fallback" id="fb">
      <div class="note">
        <p>Il visualizzatore integrato non riesce a mostrare il PDF su questo dispositivo.</p>
        <p>
          <a class="btn" id="dlBtn" download>‚¨áÔ∏è Scarica / Apri direttamente</a>
          <button class="btn" id="extBtn" type="button">üåê Apri in Safari/Browser</button>
        </p>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- util ---
  const qs = new URLSearchParams(location.search);
  const srcParam = qs.get('u') || '';
  const titleParam = qs.get('t') || '';
  const returnParam = qs.get('r') || '';
  const abs = (()=>{ try{ return new URL(srcParam, location.href).toString(); }catch(_){ return srcParam; }})();
  const sameOriginRef = (()=>{ try{ return !!document.referrer && new URL(document.referrer).origin === location.origin; }catch{ return false; }})();
  const backUrl = returnParam || (sameOriginRef ? document.referrer : './index.html');

  // --- set filename & iframe src ---
  const nameEl = document.getElementById('name');
  const fileName = titleParam || decodeURIComponent(abs.split('/').pop() || 'Documento.pdf');
  nameEl.textContent = fileName;

  const iframe = document.getElementById('pdf');
  const fb = document.getElementById('fb');
  const dlBtn = document.getElementById('dlBtn');
  const extBtn = document.getElementById('extBtn');

  // iOS 100vh fix
  function setVH(){ document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px'); }
  setVH(); window.addEventListener('resize', setVH);

  // prova a caricare nel frame, altrimenti fallback
  let fallbackArmed = false;
  function showFallback(){
    if (fallbackArmed) return;
    fallbackArmed = true;
    fb.classList.add('show');
  }

  iframe.addEventListener('error', showFallback);
  // Se entro 1200ms non abbiamo eventi di load, su alcuni iOS vecchi facciamo fallback
  const timer = setTimeout(()=>{ try { if (!iframe.contentDocument) showFallback(); } catch(_) { showFallback(); } }, 1200);

  iframe.addEventListener('load', ()=>{ clearTimeout(timer); /* ok */ });
  iframe.src = abs;

  // pulsanti azione
  dlBtn.href = abs;
  extBtn.onclick = () => { try{ window.open(abs, '_blank'); }catch(_){ location.href = abs; } };

  // Torna indietro: se c'√® history locale, usa back; altrimenti vai a index/returnParam
  const backBtn = document.getElementById('back');
  backBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    if (history.length > 1 && sameOriginRef) { history.back(); }
    else { location.href = backUrl; }
  });

  // Apri fuori dall'app (utile nelle PWA iOS)
  document.getElementById('openExt').addEventListener('click', ()=>{
    try{ window.open(abs, '_blank'); }catch(_){ location.href = abs; }
  });

  // Copia link negli appunti
  document.getElementById('copyLink').addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(abs);
      alert('Link copiato:\n' + abs);
    }catch(_){
      // Fallback
      prompt('Copia questo link:', abs);
    }
  });

})();
</script>
</body>
</html>
